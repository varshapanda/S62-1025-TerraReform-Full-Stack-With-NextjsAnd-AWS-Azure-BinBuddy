generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String                 @id @default(cuid())
  name                    String
  email                   String                 @unique
  password                String?
  googleId                String?                @unique
  points                  Int                    @default(0)
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  role                    Role                   @default(user)
  city                    String?
  state                   String?
  emailVerified           Boolean                @default(false)
  verificationToken       String?                @unique
  verificationTokenExpiry DateTime?
  passwordResetExpiry     DateTime?
  passwordResetToken      String?                @unique
  avgCompletionTime       Int?
  baseLat                 Float?
  baseLng                 Float?
  completionRate          Float                  @default(0)
  isProfileComplete       Boolean                @default(false)
  maxTasksPerDay          Int?                   @default(10)
  serviceRadius           Int?                   @default(10)
  tasksCompleted          Int                    @default(0)
  vehicleType             VehicleType?
  assignments             Assignment[]           @relation("VolunteerAssignments")
  serviceAreas            AuthorityServiceArea[]
  images                  Image[]
  notifications           Notification[]
  refreshTokens           RefreshToken[]
  reports                 Report[]
  rewards                 Reward[]
  assignedTasks           Task[]                 @relation("AssignedTasks")
  verifications           Verification[]         @relation("VolunteerVerifications")
  volunteerRequest        VolunteerRequest?
  leaderboard             UserLeaderboard?

  @@index([email])
  @@index([points])
}

model UserLeaderboard {
  userId    String   @id
  points    Int      @default(0)
  rank      Int      @default(0)
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([points])
}

model AuthorityServiceArea {
  id          String   @id @default(cuid())
  authorityId String
  city        String
  state       String
  locality    String
  priority    Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  authority   User     @relation(fields: [authorityId], references: [id], onDelete: Cascade)

  @@index([authorityId])
  @@index([city, state])
}

model Task {
  id              String     @id @default(cuid())
  reportId        String     @unique
  assignedToId    String?
  status          TaskStatus @default(PENDING)
  priority        Priority   @default(MEDIUM)
  scheduledFor    DateTime?
  startedAt       DateTime?
  completedAt     DateTime?
  cancelledAt     DateTime?
  location        Json?
  collectionProof String[]
  notes           String?
  estimatedTime   Int?
  actualTime      Int?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  assignedTo      User?      @relation("AssignedTasks", fields: [assignedToId], references: [id])
  report          Report     @relation(fields: [reportId], references: [id])

  @@index([assignedToId])
  @@index([status])
  @@index([scheduledFor])
  @@index([priority])
}

model RefreshToken {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Report {
  id              String         @id @default(cuid())
  imageUrl        String
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  category        String
  imageHash       String?        @unique
  lat             Float
  lng             Float
  note            String?
  reporterId      String
  rejectionReason String?
  remarks         String?
  verifiedAt      DateTime?
  verifiedBy      String?
  status          ReportStatus   @default(PENDING)
  address         String?
  city            String?
  houseNo         String?
  locality        String?
  pincode         String?
  state           String?
  street          String?
  assignedCount   Int            @default(0)
  priority        Int            @default(5)
  assignments     Assignment[]
  images          Image[]
  reporter        User           @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  task            Task?
  verifications   Verification[]

  @@index([reporterId])
  @@index([status])
}

model Reward {
  id          String   @id @default(cuid())
  userId      String
  points      Int
  action      String
  description String
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
}

model VolunteerRequest {
  id          Int                    @id @default(autoincrement())
  userId      String                 @unique
  status      VolunteerRequestStatus @default(PENDING)
  requestedAt DateTime               @default(now())
  reviewedAt  DateTime?
  reviewedBy  String?
  reviewNotes String?
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  user        User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("volunteer_requests")
}

model Image {
  id         String   @id @default(cuid())
  url        String
  reportId   String?
  uploadedBy String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  report Report? @relation(fields: [reportId], references: [id], onDelete: Cascade)
  user   User?   @relation(fields: [uploadedBy], references: [id])

  @@index([reportId])
  @@index([uploadedBy])
}

model Assignment {
  id          String           @id @default(cuid())
  reportId    String
  volunteerId String
  assignedAt  DateTime         @default(now())
  viewedAt    DateTime?
  completedAt DateTime?
  status      AssignmentStatus @default(PENDING)
  report      Report           @relation(fields: [reportId], references: [id], onDelete: Cascade)
  volunteer   User             @relation("VolunteerAssignments", fields: [volunteerId], references: [id], onDelete: Cascade)

  @@unique([reportId, volunteerId])
  @@index([volunteerId, status])
  @@index([reportId, status])
}

model Verification {
  id               String       @id @default(cuid())
  reportId         String
  volunteerId      String
  decision         ReportStatus
  verificationNote String?
  createdAt        DateTime     @default(now())
  report           Report       @relation(fields: [reportId], references: [id], onDelete: Cascade)
  volunteer        User         @relation("VolunteerVerifications", fields: [volunteerId], references: [id], onDelete: Cascade)

  @@unique([reportId, volunteerId])
  @@index([reportId])
}

enum Role {
  user
  admin
  volunteer
  authority
}

enum ReportStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum VolunteerRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AssignmentStatus {
  PENDING
  VIEWED
  COMPLETED
  SKIPPED
  EXPIRED
}

enum VehicleType {
  BIKE
  AUTO
  SMALL_TRUCK
  TRUCK
  OTHER
}

enum TaskStatus {
  PENDING
  ASSIGNED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Priority {
  URGENT
  HIGH
  MEDIUM
  LOW
}
