generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String            @id @default(cuid())
  name                    String
  email                   String            @unique
  password                String?
  googleId                String?           @unique
  points                  Int               @default(0)
  emailVerified           Boolean           @default(false)
  verificationToken       String?           @unique
  verificationTokenExpiry DateTime?
  passwordResetToken      String?           @unique
  passwordResetExpiry     DateTime?
  volunteerRequest        VolunteerRequest?
  assignments             Assignment[]      @relation("VolunteerAssignments")
  verifications           Verification[]    @relation("VolunteerVerifications")
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  role                    Role              @default(user)
  city                    String?
  state                   String?
  images                  Image[]
  notifications           Notification[]
  refreshTokens           RefreshToken[]
  reports                 Report[]
  rewards                 Reward[]

  // Authority-specific fields
  baseLat                 Float?
  baseLng                 Float?
  serviceRadius           Int?      @default(10)  // in km
  vehicleType             VehicleType?
  maxTasksPerDay          Int?      @default(10)
  tasksCompleted          Int       @default(0)
  completionRate          Float     @default(0)
  avgCompletionTime       Int?      // in minutes
  isProfileComplete       Boolean   @default(false)
  
  // Relations
  serviceAreas            AuthorityServiceArea[]
  assignedTasks           Task[]    @relation("AssignedTasks")

  @@index([email])
  @@index([points])
}

model AuthorityServiceArea {
  id          String    @id @default(cuid())
  authorityId String
  authority   User      @relation(fields: [authorityId], references: [id], onDelete: Cascade)
  city        String
  state       String
  locality    String
  priority    Int       @default(1)  // 1 = primary, 2 = secondary
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([authorityId])
  @@index([city, state])
}
model Task {
  id              String    @id @default(cuid())
  reportId        String    @unique
  report          Report    @relation(fields: [reportId], references: [id])
  assignedToId    String?   // Authority ID
  assignedTo      User?     @relation("AssignedTasks", fields: [assignedToId], references: [id])
  status          TaskStatus @default(PENDING)
  priority        Priority  @default(MEDIUM)
  scheduledFor    DateTime?
  startedAt       DateTime?
  completedAt     DateTime?
  cancelledAt     DateTime?
  location        Json?     // {lat, lng, address}
  collectionProof String[]  // Image URLs
  notes           String?
  estimatedTime   Int?      // in minutes
  actualTime      Int?      // in minutes
  
  // Task metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([assignedToId])
  @@index([status])
  @@index([scheduledFor])
  @@index([priority])
}

model RefreshToken {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Report {
  id        String  @id @default(cuid())
  imageUrl  String
  imageHash String? @unique
  category  String
  note      String?
  lat       Float
  lng       Float

  // Address fields
  address  String?
  houseNo  String?
  street   String?
  locality String?
  city     String?
  state    String?
  pincode  String?

  // Reporter info
  reporterId String
  reporter   User   @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  // Verification
  status          ReportStatus   @default(PENDING)
  verifiedAt      DateTime?
  verifiedBy      String?
  rejectionReason String?
  remarks         String?
  assignments     Assignment[]
  verifications   Verification[]
  priority        Int            @default(5)
  assignedCount   Int            @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  images Image[]
task Task?

  @@index([reporterId])
  @@index([status])
}

model Reward {
  id          String   @id @default(cuid())
  userId      String
  points      Int
  action      String
  description String
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
}

model VolunteerRequest {
  id          Int                    @id @default(autoincrement())
  userId      String                 @unique
  user        User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  status      VolunteerRequestStatus @default(PENDING)
  requestedAt DateTime               @default(now())
  reviewedAt  DateTime?
  reviewedBy  String?
  reviewNotes String?
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt

  @@map("volunteer_requests")
}

model Image {
  id         String   @id @default(cuid())
  url        String
  reportId   String?
  uploadedBy String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  report     Report?  @relation(fields: [reportId], references: [id], onDelete: Cascade)
  user       User?    @relation(fields: [uploadedBy], references: [id])

  @@index([reportId])
  @@index([uploadedBy])
}

enum Role {
  user
  admin
  volunteer
  authority
}

enum ReportStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum VolunteerRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model Assignment {
  id          String           @id @default(cuid())
  reportId    String
  volunteerId String
  assignedAt  DateTime         @default(now())
  viewedAt    DateTime?
  completedAt DateTime?
  status      AssignmentStatus @default(PENDING)

  report    Report @relation(fields: [reportId], references: [id], onDelete: Cascade)
  volunteer User   @relation("VolunteerAssignments", fields: [volunteerId], references: [id], onDelete: Cascade)

  @@unique([reportId, volunteerId])
  @@index([volunteerId, status])
  @@index([reportId, status])
}

model Verification {
  id               String       @id @default(cuid())
  reportId         String
  volunteerId      String
  decision         ReportStatus
  verificationNote String?
  createdAt        DateTime     @default(now())

  report    Report @relation(fields: [reportId], references: [id], onDelete: Cascade)
  volunteer User   @relation("VolunteerVerifications", fields: [volunteerId], references: [id], onDelete: Cascade)

  @@unique([reportId, volunteerId])
  @@index([reportId])
}

enum AssignmentStatus {
  PENDING
  VIEWED
  COMPLETED
  SKIPPED
  EXPIRED
}

enum VehicleType {
  BIKE
  AUTO
  SMALL_TRUCK
  TRUCK
  OTHER
}

enum TaskStatus {
  PENDING
  ASSIGNED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Priority {
  URGENT
  HIGH
  MEDIUM
  LOW
}
